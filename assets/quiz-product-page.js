const flavourImgs = {
  Natur: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
      <defs>
        <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
          <stop offset="0" stop-color="#fff"/>
          <stop offset="1" stop-color="#d8c4b0"/>
        </radialGradient>
      </defs>
      <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
      <defs>
        <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
          <stop offset="0" stop-color="#fff"/>
          <stop offset="1" stop-color="#d8c4b0"/>
        </radialGradient>
      </defs>
      <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
    </svg>
    `,
    accent_url: "",
  },
  Schokolade: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
      <defs>
        <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
          <stop offset="0" stop-color="#70463b"/>
          <stop offset="1" stop-color="#39241e"/>
        </radialGradient>
      </defs>
      <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
      <defs>
        <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
          <stop offset="0" stop-color="#70463b"/>
          <stop offset="1" stop-color="#39241e"/>
        </radialGradient>
      </defs>
      <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
    </svg>
      `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_choco.png?v=1610028427",
  },
  Waldbeere: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
      <defs>
        <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
          <stop offset="0" stop-color="#8d6f4b"/>
          <stop offset="1" stop-color="#5c3521"/>
        </radialGradient>
      </defs>
      <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
        <defs>
          <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
            <stop offset="0" stop-color="#8d6f4b"/>
            <stop offset="1" stop-color="#5c3521"/>
          </radialGradient>
        </defs>
        <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
      </svg>
      `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_cookie.png?v=1610028427",
  },
  Vanille: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
    <defs>
      <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
        <stop offset="0" stop-color="#fff6e9"/>
        <stop offset="1" stop-color="#fde0b3"/>
      </radialGradient>
    </defs>
    <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
  <defs>
    <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
      <stop offset="0" stop-color="#fff6e9"/>
      <stop offset="1" stop-color="#fde0b3"/>
    </radialGradient>
  </defs>
  <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
</svg>
      `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_vanilla.png?v=1610028427",
  },
  Banane: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
    <defs>
      <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
        <stop offset="0" stop-color="#fff2b7"/>
        <stop offset="1" stop-color="#f4ca00"/>
      </radialGradient>
    </defs>
    <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
  <defs>
    <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
      <stop offset="0" stop-color="#fff2b7"/>
      <stop offset="1" stop-color="#f4ca00"/>
    </radialGradient>
  </defs>
  <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
</svg>
      `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_banana.png?v=1610028427",
  },
  Erdbeere: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
    <defs>
      <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
        <stop offset="0" stop-color="#f8b29f"/>
        <stop offset="1" stop-color="#c00007"/>
      </radialGradient>
    </defs>
    <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
  <defs>
    <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
      <stop offset="0" stop-color="#f8b29f"/>
      <stop offset="1" stop-color="#c00007"/>
    </radialGradient>
  </defs>
  <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
</svg>
      `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_strawberry.png?v=1610028427",
  },
  Kaffee: {
    header: `
    <svg xmlns="http://www.w3.org/2000/svg" class="hide--desktop" xmlns:xlink="http://www.w3.org/1999/xlink" width="526.376" height="465.596">
    <defs>
      <radialGradient id="radial-gradient" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
        <stop offset="0" stop-color="#62504b"/>
        <stop offset="1" stop-color="#33281f"/>
      </radialGradient>
    </defs>
    <path id="Pfad_114" data-name="Pfad 114" d="M526.376,368.134H0V803.948s113.741-6.267,272.024,21.34,254.352-21.34,254.352-21.34Z" transform="translate(0 -368.134)" fill="url(#radial-gradient)"/>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" class="hide--mobile" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:1920px" width="1920" height="462.828" viewBox="0 0 1920 462.828">
  <defs>
    <radialGradient id="radial-gradient2" cx="0.5" cy="0.5" r="0.5" gradientTransform="matrix(-1, 0, 0, 1, 1, 0)" gradientUnits="objectBoundingBox">
      <stop offset="0" stop-color="#62504b"/>
      <stop offset="1" stop-color="#33281f"/>
    </radialGradient>
  </defs>
  <path id="Pfad_125" data-name="Pfad 125" d="M1920,0H0V416.089s456.788,97.631,992.23,10.686S1920,416.089,1920,416.089Z" fill="url(#radial-gradient2)"/>
</svg>
        `,
    accent_url:
      "https://cdn.shopify.com/s/files/1/0328/1826/6249/files/accent_coffee.png?v=1610028426",
  },
}

window.addEventListener("DOMContentLoaded", () => {
  $('[data-personalized-quiz-loader]').insertBefore('#shopify-section-header');

  const { getDoc, doc, firestore, auth, setDoc } = saturo
  const params = new URLSearchParams(window.location.search)
  const uidParam = params.get("uid")
  let uid = localStorage.getItem("uid") ? localStorage.getItem("uid") : null
  if (uidParam && uidParam.length > 0) {
    uid = uidParam
  }

  const pushUidUrl = (id) => {
    let url = null

    if (!params.get("uid")) {
      if (document.location.href.includes("?")) {
        url = document.location.href + `&uid=${id}`
      } else {
        url = document.location.href + `?uid=${id}`
      }
    }
    const urlWithoutReset = url.replace("reset=true", "")
    window.history.pushState("", document.title, urlWithoutReset)
  }

  const getUserData = (id = uid) => {
    return new Promise(async (resolve, reject) => {
      if (id) {
        const docRef = doc(firestore, "quiz", id)
        await getDoc(docRef)
          .then((doc) => {
            resolve(doc.data())
          })
          .catch((error) => {
            console.error("Error getting document:", error)
            reject()
          })
      } else {
        window.location.href = "/pages/quiz"
      }
    })
  }

  const writeDataToFirebase = (data, uid) => {
    return new Promise(async (resolve, reject) => {
      const docRef = doc(firestore, "quiz", uid)
      setDoc(docRef, data, { merge: true })
        .then(() => resolve())
        .catch((error) => {
          if (showConsoleLogs) {
            console.error(error)
          }
          reject()
        })
    })
  }

  saturo.writeDataToFirebase = writeDataToFirebase

  if (!uid) {
    window.location.href = "/pages/quiz?reset=true"
    return
  } else if (!uidParam) {
    pushUidUrl(uid)
  }

  getUserData()
    .then((data) => {
      buildProductPage(data)
    })
    .catch((err) => {
      console.error(err)
      window.location.href = "/pages/quiz?uid=" + uid
    })

  function buildProductPage(userData) {
    let {
      quizFormHistory,
      personal_information,
      product_details,
      product_details_variant,
      nutrition,
      label_create_datetime,
      quiz_start_datetime,
      quiz_submit_datetime
    } = userData

    const quizHistory = decodeURIComponent(quizFormHistory)

    let klaviyoObj = {
      allergy_gluten: nutrition.allergy_gluten,
      allergy_lactose: nutrition.allergy_lactose,
      allergy_other: nutrition.allergy_other,
      allergy_peanut: nutrition.allergy_peanut,
      allergy_soy: nutrition.allergy_soy,
      birthday: personal_information.birthday.toDate(),
      bmi: personal_information.bmi.toFixed(1),
      body_current: personal_information.body_current,
      body_goal: personal_information.body_goal,
      body_size: personal_information.body_size,
      first_name: personal_information.first_name,        
      gender: personal_information.gender,
      has_breakfast: nutrition.has_breakfast,
      lifestyle: personal_information.lifestyle,
      main_meal: nutrition.main_meal,
      meal_replacement_used_before: nutrition.meal_replacement_used_before,
      meal_replacement_why_gain_muscles: nutrition.meal_replacement_why_gain_muscles,
      meal_replacement_why_gain_weight: nutrition.meal_replacement_why_gain_weight,
      meal_replacement_why_increase_kcal: nutrition.meal_replacement_why_increase_kcal,
      meal_replacement_why_keep_muscles: nutrition.meal_replacement_why_keep_muscles,
      meal_replacement_why_loose_weight: nutrition.meal_replacement_why_loose_weight,
      meal_replacement_why_micro_nutrients: nutrition.meal_replacement_why_micro_nutrients,
      meal_replacement_why_other: nutrition.meal_replacement_why_other,
      meal_replacement_why_recovery: nutrition.meal_replacement_why_recovery,
      meal_replacement_why_sport_activity: nutrition.meal_replacement_why_sport_activity,
      preference_milk: nutrition.preference_milk,
      pregnant: "",
      replace_breakfast: nutrition.replace_breakfast,
      replace_dinner: nutrition.replace_dinner,
      replace_lunch: nutrition.replace_lunch,
      replace_other: nutrition.replace_other,
      replace_snack: nutrition.replace_snack,
      sleep_day: personal_information.sleep_day,
      snack: nutrition.snack,
      special_diet_keto: nutrition.special_diet_keto,
      special_diet_nopreference: nutrition.special_diet_nopreference,
      special_diet_other: nutrition.special_diet_other,
      special_diet_sugarfree: nutrition.special_diet_sugarfree,
      special_diet_vegan: nutrition.special_diet_vegan,
      special_diet_vegetarian: nutrition.special_diet_vegetarian,
      sport_duration: personal_information.sport_duration,
      sport_per_week: personal_information.sport_per_week,
      sport_type: personal_information.sport_type,
      weight_current: personal_information.weight_current,
      weight_goal: personal_information.weight_goal,
      weight_goal_week: personal_information.weight_goal_week,
      avgHrsSportPerDay: personal_information.avgHrsSportPerDay.toFixed(2),
      hydration_l_kcal_reduced: nutrition.hydration_l_kcal_reduced,
      hydration_l_other: nutrition.hydration_l_other,
      hydration_l_softdrink_fruit: nutrition.hydration_l_softdrink_fruit,
      hydration_l_total: nutrition.hydration_l_total,
      hydration_l_water: nutrition.hydration_l_water,
      performanceRate: personal_information.performanceRate.toFixed(0),
      "protein_%": nutrition['protein_%'],
      protein_g: nutrition.protein_g,
      qty_breakfast_conv: nutrition.qty_breakfast_conv,
      qty_breakfast_saturo: nutrition.qty_breakfast_saturo,
      qty_dinner_conv: nutrition.qty_dinner_conv,
      qty_dinner_saturo: nutrition.qty_dinner_saturo,
      qty_lunch_conv: nutrition.qty_lunch_conv,
      qty_lunch_saturo: nutrition.qty_lunch_saturo,
      qty_other_main_meal_conv: nutrition.qty_other_main_meal_conv,
      qty_other_main_meal_saturo: nutrition.qty_other_main_meal_saturo,
      qty_other_meal_conv: nutrition.qty_other_meal_conv,
      qty_other_meal_saturo: nutrition.qty_other_meal_saturo,
      qty_snack_saturo: nutrition.qty_snack_saturo,
      qty_snack_conv: nutrition.qty_snack_conv,
      quiz_language: window.Weglot.getCurrentLang(),
      quiz_start_datetime: quiz_start_datetime ? quiz_start_datetime.toDate() : 'null',
      quiz_submit_datetime: quiz_submit_datetime.toDate(),
      reqCal: personal_information.reqCal.toFixed(0),
      reqCalDefizit: personal_information.reqCalDefizit.toFixed(0),
      special_diet_other_comment: nutrition.special_diet_other_comment,
      sport_type_other_comment: personal_information.sport_type_other_comment,
      totalMetabolicRate: personal_information.totalMetabolicRate.toFixed(0),
      totalMetabolicRateLessHydration: personal_information.totalMetabolicRateLessHydration.toFixed(0),
      label_language: window.Weglot.getCurrentLang(),
    }

    const klaviyoObjKeys = Object.keys(klaviyoObj);
    klaviyoObjKeys.forEach((key) => {
      if (!klaviyoObj[key]) {
        klaviyoObj[key] = 'null'
      }
    });

    klaviyoObj['$email'] = personal_information.email;

    const learnqTimer = setInterval(() => {
      if (typeof _learnq === 'object') {
        clearInterval(learnqTimer);

        let _learnq = window._learnq || []

        _learnq.push(["identify", klaviyoObj]);
        
        setTimeout(() => {
          _learnq.push([
            "track",
            "Personalized Quiz",
            {
              uid,
              ...product_details,
              ...nutrition,
              ...personal_information,
            },
          ])
        }, 1000);

      }
    }, 100);

    setTimeout(() => {
      const selectedPriceText = $(
        ".product-price [data-price] .price-field:visible"
      ).text()
      product_details["ab_testing_price"] = selectedPriceText.replace(
        /[^0-9\.]/g,
        ""
      )
      $("[data-price-actual]").text(selectedPriceText)
      $("[data-price-actual]").attr("data-price-actual", selectedPriceText)
      
      localStorage.setItem("quiz-status", "quiz-completed")

      // TODO Remove products from HTML code
      window.quizProducts = []
      $("script[data-products-script]").remove()
    }, 100)

    let perfectProduct = window.quizProducts.filter(
      (item) => item.ProductId === product_details.product_id
    )[0]
    

    // ---------------------- IF PERFECT PRODUCT START ------------------------
    let variantMetafields = null
    let selected_variant = null
    let nutritionDetails = []
    let macroObject = []
    let portionWaterMlVariant = null
    const portion_water_viscosity = 1 // Hardcoded Constanct

    selected_variant = perfectProduct.ProductVariants.filter(
      (item) => item.variantTitle === product_details_variant[1].flavor
    )

    if (selected_variant.length > 0) {
      variantMetafields = selected_variant[0].metafields

      $("[data-product-bg-color]").css(
        "background-color",
        variantMetafields.bg_color
      )

      const textStyles = `<style>
        .quiz-result .product__header--content .h1-headline,
        .quiz-result .product__header--content .h5-headline,
        .quiz-result__checklist-title,
        .quiz-result .product__header--content .h1-headline,
        .quiz-result .product__header--image-meta div,
        .quiz-result .product__header--image-meta p,
        .quiz-result .product__header--image-meta > span,
        .quiz-result .product__header--image-meta a,
        .quiz-result .product__header--content-image--label,
        .quiz-result .macro-table,
        .quiz-result .macro-table .h2-headline,
        .quiz-result .macro-table .details,
        .quiz-result .macro-table .p {
          color: ${variantMetafields.text_color}!important;
        }
        .quiz-result .product__header--content .heading-line {
          background-color: ${variantMetafields.text_color}!important;
        }
        .quiz-result .product-price-delivery-text svg path,
        .product__header--content-icons svg path {
          fill: ${variantMetafields.text_color}!important;
        }
      </style>`
      $("body").append(textStyles)

      $("[data-quiz-add-to-cart]").attr(
        "data-quiz-add-to-cart",
        selected_variant[0].variantId
      )
      const params = new URLSearchParams(window.location.search)
      if (params.get("uid")) {
        $("[data-quiz-add-to-cart]").attr("data-quiz-uid", params.get("uid"))
      }

      $("[data-meta-shipping-unit-servings]").text(
        perfectProduct.ProductMetafields.shipping_unit_servings
      )
      $("[data-product-flavor]").text(product_details_variant[1].flavor)

      $("[data-meta-macro-carbs]").text(
        product_details_variant[1].makrosplit_carbohydrate
      )
      $("[data-meta-macro-protein]").text(
        product_details_variant[1].makrosplit_protein
      )
      $("[data-meta-macro-fibre]").text(
        product_details_variant[1].makrosplit_fibre
      )
      $("[data-meta-macro-fat]").text(product_details_variant[1].makrosplit_fat)

      $("[data-meta-macro-desk]").text(
        perfectProduct.ProductMetafields.makrosplit_desc
      )
      $("[data-meta-macro-img]").attr(
        "src",
        perfectProduct.ProductMetafields.makrosplit_img
      )

      let ingredients_1_img = perfectProduct.ProductMetafields.ingredients_1_img
      if (variantMetafields.ingredients_1_img.length > 0) {
        ingredients_1_img = variantMetafields.ingredients_1_img
      }
      let ingredients_2_img = perfectProduct.ProductMetafields.ingredients_2_img
      if (variantMetafields.ingredients_2_img.length > 0) {
        ingredients_2_img = variantMetafields.ingredients_2_img
      }
      let ingredients_3_img = perfectProduct.ProductMetafields.ingredients_3_img
      if (variantMetafields.ingredients_3_img.length > 0) {
        ingredients_3_img = variantMetafields.ingredients_3_img
      }
      let ingredients_4_img = perfectProduct.ProductMetafields.ingredients_4_img
      if (variantMetafields.ingredients_4_img.length > 0) {
        ingredients_4_img = variantMetafields.ingredients_4_img
      }

      $("[data-meta-macro-ingre-img1]").attr("src", ingredients_1_img)
      $("[data-meta-macro-ingre-img2]").attr("src", ingredients_2_img)
      $("[data-meta-macro-ingre-img3]").attr("src", ingredients_3_img)
      $("[data-meta-macro-ingre-img4]").attr("src", ingredients_4_img)

      let ingredients_1_desc =
        perfectProduct.ProductMetafields.ingredients_1_desc
      if (variantMetafields.ingredients_1_desc.length > 0) {
        ingredients_1_desc = variantMetafields.ingredients_1_desc
      }
      let ingredients_2_desc =
        perfectProduct.ProductMetafields.ingredients_2_desc
      if (variantMetafields.ingredients_2_desc.length > 0) {
        ingredients_2_desc = variantMetafields.ingredients_2_desc
      }
      let ingredients_3_desc =
        perfectProduct.ProductMetafields.ingredients_3_desc
      if (variantMetafields.ingredients_3_desc.length > 0) {
        ingredients_3_desc = variantMetafields.ingredients_3_desc
      }
      let ingredients_4_desc =
        perfectProduct.ProductMetafields.ingredients_4_desc
      if (variantMetafields.ingredients_4_desc.length > 0) {
        ingredients_4_desc = variantMetafields.ingredients_4_desc
      }
      $("[data-meta-macro-ingre-desc1]").html(ingredients_1_desc)
      $("[data-meta-macro-ingre-desc2]").html(ingredients_2_desc)
      $("[data-meta-macro-ingre-desc3]").html(ingredients_3_desc)
      $("[data-meta-macro-ingre-desc4]").html(ingredients_4_desc)

      $("[data-flavor-icon]").attr("src", variantMetafields.flavor_icon)
      $("head").append(
        `<style>[data-product-bg-color] .product__header-grid:before{background-color: ${variantMetafields.circle_color};}</style>`
      )

      $("[data-quiz-user-name]").text(personal_information.first_name)
      $("[data-quiz-variant-name]").text(selected_variant[0].variantTitle)

      const portionSizeKcal = nutrition.portion_saturo_average
      const portionSaturoSize = nutrition.portion_saturo_average
      portionWaterMlVariant = Number(variantMetafields.portion_water_ml)

      const calcPortionWaterMl =
        (portionWaterMlVariant /
          parseInt(variantMetafields.portion_g, 10)) *
        portionSaturoSize

      $("[data-water-ml]").text(Math.round(calcPortionWaterMl) + " ml")

      const scoopG = 33
      const calcScoopNumber = portionSaturoSize / scoopG

      $("[data-spoons-number]").text(Math.round(calcScoopNumber))

      if (variantMetafields.nutrition_details) {
        nutritionDetails = JSON.parse(variantMetafields.nutrition_details)
      }

      if (
        perfectProduct.ProductPriceMetafield &&
        perfectProduct.ProductPriceMetafield.length > 0
      ) {
        const format = (num, decimals) =>
          num.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })

        const fillingSizeNumber = parseFloat(variantMetafields.filling_size)
        const fillingSizeGNumber = parseFloat(variantMetafields.filling_size_g)
        const mealsPerBox = fillingSizeNumber / portionSizeKcal

        $("[data-price-per-meal]").html("")
        $("[data-original-price-per-100g]").html("")

        const productPriceNoCurrency = quizProducts.filter(
          (product) => product.ProductId === perfectProduct.ProductId
        )[0].ProductPriceNoCurrency
        const productPriceNoCurrencyNumber = Number(
          productPriceNoCurrency.replace(",", ".")
        )

        const pricePer100g =
          (productPriceNoCurrencyNumber / fillingSizeGNumber) * 100
        const pricePerMeal = productPriceNoCurrencyNumber / mealsPerBox

        $("[data-price-per-meal]").append(
          `<span class="price-field price-field">&euro;${format(
            pricePerMeal
          )}</span>`
        )
        $("[data-original-price-per-100g]").append(
          `<span class="price-field price-field">&euro;${format(
            pricePer100g
          )}</span>`
        )

        $(".product__header [data-price]").html("")
        $(".product__header [data-price]").append(
          `<span class="price-field">&euro;${productPriceNoCurrencyNumber}</span>`
        )

        $("[data-meta-shipping-unit-servings]").text(mealsPerBox.toFixed(0))
        $("[data-filling-size-g]").text(fillingSizeGNumber + "g")
      }

      const energy100 = nutritionDetails.filter(
        (item) => item.name === "Energy"
      )[0].per_100

      function createTable(tableElement, portion) {
        tableElement.find(".js-quiz-macro-table tbody").html("")
        let macroTable = ""

        nutritionDetails.forEach((item) => {
          if (item.name === "title") {
            macroTable += `<tr>
              <td style="width: 235px;"><strong>${item.label}</strong></td>
              <td style="width: 45px;"></td>
              <td style="width: 45px;"></td>
              <td style="width: 45px;"></td>
            </tr>`
            return
          }
          let per100 = item.per_100

          let perPortion = (per100 / 100) * portion

          if (item.name === "Portion size") {
            perPortion = portion
          }

          let riNrv =
            item.daily_intake != 0 ? (perPortion / item.daily_intake) * 100 : 0

          macroTable += `<tr>
          <td style="width: 235px;${
            item.parent && item.parent.length > 0
              ? " padding-left: 1.5rem;"
              : ""
          }">${item.label} (${item.metric})</td>
          <td style="width: 45px;">${
            per100 != 0 ? Number(per100).toFixed(1) : ""
          }</td>
          <td style="width: 45px;">${
            perPortion != 0 ? Number(perPortion).toFixed(1) : ""
          }</td>
          <td style="width: 45px;">${
            riNrv != 0 ? Number(riNrv).toFixed(0) + "%" : ""
          }</td>
        </tr>`

          macroObject.push({
            name: item.name,
            label: item.label,
            metric: item.metric,
            per100,
            perPortion,
          })
        })

        tableElement.find(".js-quiz-macro-table tbody").append(macroTable)

        
        if (tableElement.find("[data-per-portion]").length > 0) {
          tableElement.find("[data-per-portion]").text(portion.toFixed(1) + " g")
        }
      }

      let available_portion_g_breakfast_saturo = null;
      if (!product_details_variant[1].portion_g_breakfast_saturo) {
        available_portion_g_breakfast_saturo = nutrition.portion_g_breakfast_saturo;
        
        writeDataToFirebase({
          product_details_variant: {
            "1": {
              "portion_g_breakfast_saturo": nutrition.portion_g_breakfast_saturo ? nutrition.portion_g_breakfast_saturo : 'null'
            }
          }
        }, uid)
      } else {
        available_portion_g_breakfast_saturo = product_details_variant[1].portion_g_breakfast_saturo;
      }

      let available_portion_g_lunch_saturo = null;
      if (!product_details_variant[1].portion_g_lunch_saturo) {
        available_portion_g_lunch_saturo = nutrition.portion_g_lunch_saturo;
        
        writeDataToFirebase({
          product_details_variant: {
            "1": {
              "portion_g_lunch_saturo": nutrition.portion_g_lunch_saturo ? nutrition.portion_g_lunch_saturo : 'null'
            }
          }
        }, uid)
      } else {
        available_portion_g_lunch_saturo = product_details_variant[1].portion_g_lunch_saturo;
      }

      let available_portion_g_dinner_saturo = null;
      if (!product_details_variant[1].portion_g_dinner_saturo) {
        available_portion_g_dinner_saturo = nutrition.portion_g_dinner_saturo;
        
        writeDataToFirebase({
          product_details_variant: {
            "1": {
              "portion_g_dinner_saturo": nutrition.portion_g_dinner_saturo ? nutrition.portion_g_dinner_saturo : 'null'
            }
          }
        }, uid)
      } else {
        available_portion_g_dinner_saturo = product_details_variant[1].portion_g_dinner_saturo;
      }

      let available_portion_g_snack_saturo = null;
      if (!product_details_variant[1].portion_g_snack_saturo) {
        available_portion_g_snack_saturo = nutrition.portion_g_snack_saturo;
        
        writeDataToFirebase({
          product_details_variant: {
            "1": {
              "portion_g_snack_saturo": nutrition.portion_g_snack_saturo ? nutrition.portion_g_snack_saturo : 'null'
            }
          }
        }, uid)
      } else {
        available_portion_g_snack_saturo = product_details_variant[1].portion_g_snack_saturo;
      }

      if (nutrition.portion_breakfast_saturo != 0) {
        createTable(
          $("[data-table-saturo-breakfast]"),
          available_portion_g_breakfast_saturo
        )
      } else {
        $("[data-table-saturo-breakfast]").remove()
      }

      if (nutrition.portion_lunch_saturo != 0) {
        createTable(
          $("[data-table-saturo-lunch]"),
          available_portion_g_lunch_saturo
        )
      } else {
        $("[data-table-saturo-lunch]").remove()
      }

      if (nutrition.portion_dinner_saturo != 0) {
        createTable(
          $("[data-table-saturo-dinner]"),
          available_portion_g_dinner_saturo
        )
      } else {
        $("[data-table-saturo-dinner]").remove()
      }

      if (nutrition.portion_snack_saturo != 0) {
        createTable(
          $("[data-table-saturo-snack]"),
          available_portion_g_snack_saturo
        )
      } else {
        $("[data-table-saturo-snack]").remove()
      }

      const mealsReplacementUseDay = quizHistory
        .split("&")
        .map((item) => {
          if (item.includes("meal_replacement_use_day")) {
            if (item.split.length > 1 && item.split("=")[1]) {
              return item.split("=")[1]
            }
          }
        })
        .filter((item) => typeof item === "string")
      $("[data-meal-to-be-replaced]").text(mealsReplacementUseDay.join(", "))
      $("[data-product-benefits]").text(
        perfectProduct.ProductMetafields.product_benefits
      )
      if (variantMetafields.product_benefits) {
        $("[data-product-benefits]").text(variantMetafields.product_benefits)
      }
      $("[data-personalized-ingredients]").html(
        variantMetafields.personalized_ingredients
      )

      if (perfectProduct.ProductMetafields.personalized_ingredients_headline) {
        $("[data-personalized-ingredients-headline]").html(
          perfectProduct.ProductMetafields.personalized_ingredients_headline
        )
      }
      if (variantMetafields.personalized_ingredients_headline) {
        $("[data-personalized-ingredients-headline]").html(
          variantMetafields.personalized_ingredients_headline
        )
      }

      $("[data-variant-product-form-image]").attr(
        "src",
        selected_variant[0].variantImg
      )

      $("body > .coll-v2__modal").remove()
      $("[data-coll-modal]").attr("data-product", perfectProduct.ProductName)

      const selectedProduct = {}
      macroObject = [
        { Water_portion: calcPortionWaterMl },
        { Portion_size: portionSaturoSize },
        { Scoop_g: scoopG },
        { Scoop_number: calcScoopNumber },
        ...macroObject,
      ]

      selectedProduct[
        "productdetails_" + Math.round(new Date().getTime() / 1000)
      ] = macroObject
    }

    // ---------------------- IF PERFECT PRODUCT END ------------------------

    document.body.classList.add("showProductInitialized")
    const { flavor: flavour } = product_details_variant[1]
    const { first_name: name } = personal_information
    const {
      ProductPrice,
      ProductVariants,
      Ingredients,
      Nutritionalvalues,
      ProductName,
      ProductPriceMetafield,
      Faq,
    } = perfectProduct

    $("[data-prod-initial-qty] [data-qty]").on("change", function () {
      const $selectedVariantFlavourQty = $(
        '[data-quiz-result-flavour="' + flavour + '"] [data-qty]'
      )
      if (!$selectedVariantFlavourQty.length) {
        return
      }
      $selectedVariantFlavourQty.val(
        $("[data-prod-initial-qty] [data-qty]").val()
      )
    })

    if (Faq) {
      Faq.forEach((faq, index) => {
        const faqItem = `
      <dt><button class="faq__item-button p" type="button" aria-controls="panel-${index}" data-button-id="${index}" aria-expanded="true">
        <strong>${faq.question}</strong>
        <svg class="icon icon-cross" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.55064 14.7129L14.7128 3.55069C14.9499 3.31358 14.9311 2.91034 14.6707 2.64997L13.4922 1.47146C13.2319 1.2111 12.8286 1.19226 12.5915 1.42937L1.42931 12.5916C1.1922 12.8287 1.21104 13.2319 1.4714 13.4923L2.64992 14.6708C2.91028 14.9312 3.31352 14.95 3.55064 14.7129Z" fill="#363330"></path>
          <path d="M1.42909 3.57151L12.5913 14.7337C12.8284 14.9708 13.2316 14.952 13.492 14.6916L14.6705 13.5131C14.9309 13.2527 14.9497 12.8495 14.7126 12.6124L3.55041 1.45019C3.31329 1.21307 2.91005 1.23192 2.64969 1.49228L1.47118 2.67079C1.21082 2.93115 1.19197 3.33439 1.42909 3.57151Z" fill="#363330"></path>
        </svg> 
      </button></dt>
      <dd class="faq__item-content p" data-content-id="${index}" aria-hidden="true">
        <p>${faq.answer}</p>
      </dd>`

        $(".js-faq-items").append(faqItem)
      })

      $("body").on("click", "[data-button-id]", function () {
        var id = $(this).attr("data-button-id")
        var $content = $(`[data-content-id="${id}"]`)

        if ($content.hasClass("show")) {
          $content.removeClass("show")
          $(this).removeClass("active")
          $content.attr("aria-hidden", "true")
        } else {
          $content.addClass("show")
          $(this).addClass("active")
          $content.attr("aria-hidden", "false")
        }
      })
    }

    $("[data-product-username]").text(name)
    const selectedVariant = ProductVariants.find(
      (variant) => variant.variantTitle === flavour
    )
    const { variantImg } = selectedVariant
    $("[data-product-image]").attr("src", variantImg)

    const { header, accent_url } = flavourImgs[flavour]
    const $flavourSelectionItem = $("[data-quiz-result-flavour]")
    $('[data-quiz-result-flavour="' + flavour + '"]')
      .find("[data-qty]")
      .val(1)
    if (header) {
      $("[data-quiz-result-header]").html(header)
    }

    if (accent_url) {
      const $quizAccentBg = $("[data-quiz-result-accent-bg]")
      $quizAccentBg.css("backgroundImage", `url(${accent_url})`)
      $quizAccentBg.removeClass("d-none")

      $flavourSelectionItem.each(function (index, item) {
        const $item = $(item)
        $item.css(
          "backgroundImage",
          `url(${
            flavourImgs[$item.attr("data-quiz-result-flavour")].accent_url
          })`
        )
        $item.css("backgroundSize", "cover")
        $item.css("backgroundPosition", "center")
      })
    }

    const sportTypeItems = quizHistory.split("&").filter((item) => {
      if (item.includes("sport_type")) {
        if (item.split.length > 1 && item.split("=")[1]) {
          return item
        }
      }
    })

    if (sportTypeItems.length === 0) {
      $(".single-high__subtitle").remove()
    }

    const $quizIcons = $("[data-quiz-result-icons]")
    if (sportTypeItems.length > 0) {
      sportTypeItems.forEach((item) => {
        $quizIcons
          .find(`[data-quiz-icon="${item.split("=")[1]}"]`)
          .attr("data-keep", "true")
      })
    }
    $quizIcons.find(`[data-quiz-icon]:not([data-keep])`).remove()

    const $singleHighlightS2Items = $("[data-single-high-s2-items]")
    if (sportTypeItems.length > 0) {
      sportTypeItems.forEach(function (item) {
        $singleHighlightS2Items
          .find(`[data-s2-item][data-value="${item.split("=")[1]}"]`)
          .attr("data-keep", "true")
      })
    }
    $singleHighlightS2Items.find(`[data-s2-item]:not([data-keep])`).remove()

    $("[data-single-high-body-height]").text(personal_information.body_size)
    $("[data-single-high-current-weight]").text(
      personal_information.weight_current
    )
    $("[data-card-weight-goal]").text(personal_information.weight_goal)
    $("[data-card-body-goal] strong").text(personal_information.body_goal)

    if (
      personal_information.weight_current === personal_information.weight_goal
    ) {
      $("[data-card-weight-goal-week]").closest(".card__section-item").remove()
    } else {
      $("[data-card-weight-goal-week]").text(
        personal_information.weight_goal_week
      )
    }

    $("[data-card-square-req-cal]").text(personal_information.reqCal.toFixed(0))
    $("[data-card-square-base-rate]").text(
      personal_information.baseRate.toFixed(0)
    )
    $("[data-card-square-performance-rate]").text(
      personal_information.performanceRate.toFixed(0)
    )
    $("[data-card-square-req-cal-defizit]").text(
      personal_information.reqCalDefizit.toFixed(0)
    )

    if (nutrition.portion_breakfast_saturo != 0) {
      $(
        "[data-card-square-portion-breakfast-saturo] [data-card-square-value] strong"
      ).text(nutrition.portion_breakfast_saturo.toFixed(0))
    } else {
      $("[data-card-square-portion-breakfast-saturo]").remove()
    }
    if (nutrition.portion_lunch_saturo != 0) {
      $(
        "[data-card-square-portion-lunch-saturo] [data-card-square-value] strong"
      ).text(nutrition.portion_lunch_saturo.toFixed(0))
    } else {
      $("[data-card-square-portion-lunch-saturo]").remove()
    }
    if (nutrition.portion_dinner_saturo != 0) {
      $(
        "[data-card-square-portion-dinner-saturo] [data-card-square-value] strong"
      ).text(nutrition.portion_dinner_saturo.toFixed(0))
    } else {
      $("[data-card-square-portion-dinner-saturo]").remove()
    }
    if (nutrition.portion_snack_saturo != 0) {
      $(
        "[data-card-square-portion-snack-saturo] [data-card-square-value] strong"
      ).text(nutrition.portion_snack_saturo.toFixed(0))
    } else {
      $("[data-card-square-portion-snack-saturo]").remove()
    }

    if (
      nutrition.portion_breakfast_saturo != 0 &&
      nutrition.portion_lunch_saturo != 0 &&
      nutrition.portion_dinner_saturo != 0 &&
      nutrition.portion_snack_saturo != 0
    ) {
      $(".card-square__cards-title").remove()
    }

    const mealReplacementWhyItems = quizHistory.split("&").filter((item) => {
      if (item.includes("meal_replacement_why")) {
        if (item.split.length > 1 && item.split("=")[1]) {
          return item
        }
      }
    })
    if (mealReplacementWhyItems.length > 0) {
      mealReplacementWhyItems.forEach((item) => {
        const val = item.split("=")[1]
        $(`.js-card__cards [data-card-id="${val}"]`).attr("data-keep", "true")

        if (personal_information.gender === "female") {
          $(`.js-card__cards [data-card-id="${val}"]`).addClass("women")
        }
      })
      $(`.js-card__cards [data-card-id]:not([data-keep])`).remove()
    } else {
      $("[data-card-your-sports-text]").remove()
    }

    const $cards = document.querySelector(".js-card__cards")
    if ($cards && $cards.childElementCount > 1) {
      setTimeout(() => {
        new Glider(document.querySelector(".js-card__cards"), {
          slidesToShow: "auto",
          slidesToScroll: 1,
          draggable: true,
          itemWidth: 315,
          exactWidth: true,
          responsive: [
            {
              breakpoint: 1024,
              settings: {
                slidesToShow: 3,
                slidesToScroll: 1,
              },
            },
          ],
        })
      }, 0)
    } else {
      $cards.classList.add("single-item")
    }

    const $cardsSquare = document.querySelector(".js-card-square__cards")
    if ($cardsSquare && $cardsSquare.childElementCount > 2) {
      new Glider(document.querySelector(".js-card-square__cards"), {
        slidesToShow: "auto",
        slidesToScroll: 1,
        draggable: true,
        itemWidth: 243,
        exactWidth: true,
        responsive: [
          {
            breakpoint: 1024,
            settings: {
              slidesToShow: 3,
              itemWidth: 315,
            },
          },
        ],
      })
    } else {
      $cardsSquare.classList.add("single-item")
    }

    const $macroTables = document.querySelector(".js-macro-tables")
    if ($macroTables && $macroTables.childElementCount > 1) {
      const macroTablesGlider = new Glider(
        document.querySelector(".js-macro-tables"),
        {
          slidesToShow: "auto",
          itemWidth: 480,
          slidesToScroll: 1,
          draggable: true,
          dots: ".macro-tables__dots",
          arrows: {
            prev: ".glider-prev",
            next: ".glider-next",
          },
          responsive: [
            {
              breakpoint: 1024,
              settings: {
                slidesToShow: 2,
                dots: false,
              },
            },
            {
              breakpoint: 768,
              settings: {
                dots: false,
              },
            },
          ],
        }
      )

      $("body").on("click", "[data-go-macro-table]", function (e) {
        e.preventDefault()
        const id = $(this).attr("data-go-macro-table")
        $("#macrotables").get(0).scrollIntoView()
        macroTablesGlider.scrollItem(Number(id))
      })

      $("[data-go-macro-table]").each(function (index, item) {
        $(item).attr("data-go-macro-table", index)
      })
    } else {
      $macroTables.classList.add("single-item")

      $("body").on("click", "[data-go-macro-table]", function (e) {
        e.preventDefault()
        const id = $(this).attr("data-go-macro-table")
        $("#macrotables").get(0).scrollIntoView()
      })

      $("[data-go-macro-table]").each(function (index, item) {
        $(item).attr("data-go-macro-table", index)
      })
    }

    const $macroTableButtons = document.querySelectorAll(
      ".macro-table__accordion-btn"
    )
    if ($macroTableButtons) {
      $macroTableButtons.forEach((macroTableButton) => {
        macroTableButton.addEventListener("click", function () {
          var id = macroTableButton.dataset.buttonId
          var $content = document.querySelector(
            '[data-content-id="' + id + '"]'
          )

          if ($content.classList.contains("show")) {
            $content.classList.remove("show")
            macroTableButton.classList.remove("active")
          } else {
            $content.classList.add("show")
            macroTableButton.classList.add("active")
          }
        })
      })
    }

    const $variantItems = $("[data-personalized-variants-items]")
    perfectProduct.ProductVariants.forEach((variant) => {
      const variantClone = $variantItems
        .find("[data-variant-wrapper]:not(.ready)")
        .clone(true, true)
      variantClone.addClass("ready")
      variantClone
        .find("[data-variant-id]")
        .attr("data-variant-id", variant.variantId)
      variantClone
        .find("[data-quiz-variant-image]")
        .attr("src", variant.variantImg)
      variantClone.find("[data-quiz-variant-title]").text(variant.variantTitle)
      variantClone
        .find("[data-qty-input]")
        .attr("data-qty-input", variant.variantId)
      if (variant.variantTitle === product_details_variant[1].flavor) {
        variantClone.addClass("selected")
      }
      $variantItems.append(variantClone)
    })
    $variantItems.find("[data-variant-wrapper]:not(.ready)").remove()

    function createProductDetailsVariant(variant) {
      let macroObject = []
      const variantId = variant.variantId
      const variantMetafields = variant.metafields
      const nutritionDetails = JSON.parse(variant.metafields.nutrition_details)
      const flavor = variant.variantTitle
      const best_before_date = new Date(
        variantMetafields.details_best_before_date
      )
      const filling_size_kcal = parseFloat(variantMetafields.filling_size)
      const filling_size_g = Number(variantMetafields.filling_size_g)
      const ingredients = variantMetafields.ingredients
      const portion_g = Number(variantMetafields.portion_g)
      const portion_water_ml = Number(variantMetafields.portion_water_ml)

      const scoop_size_g_unit = variantMetafields.scoop_size_g_unit
      const scoop_size_g = Number(variantMetafields.scoop_size_g)
          
      const usp_1 = variantMetafields.personalized_usp_1
        ? variantMetafields.personalized_usp_1
        : perfectProduct.ProductMetafields.personalized_usp_1
      const usp_2 = variantMetafields.personalized_usp_2
        ? variantMetafields.personalized_usp_2
        : perfectProduct.ProductMetafields.personalized_usp_2
      const usp_3 = variantMetafields.personalized_usp_3
        ? variantMetafields.personalized_usp_3
        : perfectProduct.ProductMetafields.personalized_usp_3
      const usp_header = variantMetafields.personalized_usp_header
        ? variantMetafields.personalized_usp_header
        : perfectProduct.ProductMetafields.personalized_usp_header
      const makrosplit_fibre = Number(
        perfectProduct.ProductMetafields.makrosplit_fibre
      )
      const makrosplit_protein = Number(
        perfectProduct.ProductMetafields.makrosplit_protein
      )
      const makrosplit_fat = Number(
        perfectProduct.ProductMetafields.makrosplit_fat
      )
      const makrosplit_carbohydrate = Number(
        perfectProduct.ProductMetafields.makrosplit_carbohydrate
      )
      const gluten =
        typeof variantMetafields.Gluten !== "undefined"
          ? variantMetafields.Gluten === "true"
          : perfectProduct.Gluten.toLowerCase() === "true"
      const peanut =
        typeof variantMetafields.Peanut !== "undefined"
          ? variantMetafields.Peanut === "true"
          : perfectProduct.Peanut.toLowerCase() === "true"
      const sugarfree =
        typeof variantMetafields.Sugarfree !== "undefined"
          ? variantMetafields.Sugarfree === "true"
          : perfectProduct.Sugarfree.toLowerCase() === "true"
      const product_charge = variantMetafields.details_product_charge

      const energy100 = nutritionDetails.filter(
        (item) => item.name === "Energy"
      )[0].per_100
      let portion_g_breakfast_saturo =
        (nutrition.portion_breakfast_saturo / energy100) * 100
      let portion_g_lunch_saturo =
        (nutrition.portion_lunch_saturo / energy100) * 100
      let portion_g_dinner_saturo =
        (nutrition.portion_dinner_saturo / energy100) * 100
      let portion_g_other_main_meal_saturo =
        (nutrition.portion_other_main_meal_saturo / energy100) * 100
      let portion_g_snack_saturo =
        (nutrition.portion_snack_saturo / energy100) * 100
      let portion_g_other_meal_saturo =
        (nutrition.portion_other_meal_saturo / energy100) * 100

      nutritionDetails.forEach((item) => {
        if (item.name === "title") {
          return
        }
        let per100 = item.per_100
        // let riNrv =
        //   item.daily_intake != 0 ? (perPortion / item.daily_intake) * 100 : 0

        macroObject.push({
          name: item.name,
          label: item.label,
          metric: item.metric,
          per100,
        })
      })

      const nutritionFacts100g = macroObject
        .filter((item) => item.name)
        .map((item) => {
          return {
            name: item.name,
            value: item.per100,
          }
        })

      let nutritionFactsBreakfast = null
      if (nutrition.portion_breakfast_saturo > 0) {
        nutritionFactsBreakfast = nutritionFacts100g.map((item) => {
          return {
            name: item.name,
            value: (item.value / 100) * portion_g_breakfast_saturo,
          }
        })
      }

      let nutritionFactsLunch = null
      if (nutrition.portion_lunch_saturo > 0) {
        nutritionFactsLunch = nutritionFacts100g.map((item) => {
          return {
            name: item.name,
            value: (item.value / 100) * portion_g_lunch_saturo,
          }
        })
      }

      let nutritionFactsDinner = null
      if (nutrition.portion_dinner_saturo > 0) {
        nutritionFactsDinner = nutritionFacts100g.map((item) => {
          return {
            name: item.name,
            value: (item.value / 100) * portion_g_dinner_saturo,
          }
        })
      }

      let nutritionFactsSnack = null
      if (nutrition.portion_snack_saturo > 0) {
        nutritionFactsSnack = nutritionFacts100g.map((item) => {
          return {
            name: item.name,
            value: (item.value / 100) * portion_g_snack_saturo,
          }
        })
      }

      let nutritionFactsOtherMeal = null
      if (nutrition.portion_other_meal_saturo > 0) {
        nutritionFactsOtherMeal = nutritionFacts100g.map((item) => {
          return {
            name: item.name,
            value: (item.value / 100) * portion_g_other_meal_saturo,
          }
        })
      }

      let nutrition_facts_table_combined = nutritionDetails.map((item) => {
        if (item.name === 'title') {
          return {
            name: item.name,
            label: item.label
          }
        }
      
        const nutrition_facts_breakfast_portion = portion_g_breakfast_saturo ? (item.per_100 / 100) * portion_g_breakfast_saturo : null
        const nutrition_facts_lunch_portion = portion_g_lunch_saturo ? (item.per_100 / 100) * portion_g_lunch_saturo : null
        const nutrition_facts_dinner_portion = portion_g_dinner_saturo ? (item.per_100 / 100) * portion_g_dinner_saturo : null
        const nutrition_facts_snack_portion = portion_g_snack_saturo ? (item.per_100 / 100) * portion_g_snack_saturo : null

        const nutrition_facts_riNrv = item.daily_intake && item.daily_intake != 0 ? (item.per_100 / item.daily_intake) * 100 : 0
        const nutrition_facts_breakfast_riNrv = nutrition_facts_breakfast_portion ? item.daily_intake != 0 ? (nutrition_facts_breakfast_portion / item.daily_intake) * 100 : 0 : null
        const nutrition_facts_lunch_riNrv = nutrition_facts_lunch_portion ? item.daily_intake != 0 ? (nutrition_facts_lunch_portion / item.daily_intake) * 100 : 0 : null
        const nutrition_facts_dinner_riNrv = nutrition_facts_dinner_portion ? item.daily_intake != 0 ? (nutrition_facts_dinner_portion / item.daily_intake) * 100 : 0 : null
        const nutrition_facts_snack_riNrv = nutrition_facts_snack_portion ? item.daily_intake != 0 ? (nutrition_facts_snack_portion / item.daily_intake) * 100 : 0 : null
        
        function significantDigits(val, digits) {
          // If the value's length is higher than the digits, we replace the digits
          // To avoid weird toPrecision values
          // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/toPrecision
          const valLength = parseInt(val).toString().length;
          let significant_digits = digits;
          if (valLength > digits) {
            significant_digits = valLength;
          }
          return val.toPrecision(significant_digits)
        }

        let combinedObj = {
          name: item.name,
          label: item.label,
          metric: item.metric,
          nutrition_facts_100g: significantDigits(item.per_100, item.significant_digits),
          nutrition_facts_100g_riNrv: nutrition_facts_riNrv ? nutrition_facts_riNrv.toFixed(0) : null,
        }
      
        if (nutrition_facts_breakfast_portion) {
          combinedObj.nutrition_facts_breakfast = significantDigits(nutrition_facts_breakfast_portion, item.significant_digits);
          combinedObj.nutrition_facts_breakfast_riNrv = nutrition_facts_breakfast_riNrv ? nutrition_facts_breakfast_riNrv.toFixed(0) : null;
        }

        if (nutrition_facts_lunch_portion) {
          combinedObj.nutrition_facts_lunch = significantDigits(nutrition_facts_lunch_portion, item.significant_digits);
          combinedObj.nutrition_facts_lunch_riNrv = nutrition_facts_lunch_riNrv ? nutrition_facts_lunch_riNrv.toFixed(0) : null;
        }

        if (nutrition_facts_dinner_portion) {
          combinedObj.nutrition_facts_dinner = significantDigits(nutrition_facts_dinner_portion, item.significant_digits);
          combinedObj.nutrition_facts_dinner_riNrv = nutrition_facts_dinner_riNrv ? nutrition_facts_dinner_riNrv.toFixed(0) : null;
        }

        if (nutrition_facts_snack_portion) {
          combinedObj.nutrition_facts_snack = significantDigits(nutrition_facts_snack_portion, item.significant_digits);
          combinedObj.nutrition_facts_snack_riNrv = nutrition_facts_snack_riNrv ? nutrition_facts_snack_riNrv.toFixed(0) : null;
        }

        return combinedObj;
      });

      const portion_water_ml_breakfast_saturo = portion_g_breakfast_saturo != 0 ? (portionWaterMlVariant / 100 )* portion_g_breakfast_saturo * portion_water_viscosity : null;
      const portion_water_ml_lunch_saturo = portion_g_lunch_saturo != 0 ? (portionWaterMlVariant / 100) * portion_g_lunch_saturo * portion_water_viscosity : null;
      const portion_water_ml_dinner_saturo = portion_g_dinner_saturo != 0 ? (portionWaterMlVariant / 100) * portion_g_dinner_saturo * portion_water_viscosity : null;
      const portion_water_ml_other_main_meal_saturo = portion_g_other_main_meal_saturo != 0 ? (portionWaterMlVariant / 100) * portion_g_other_main_meal_saturo * portion_water_viscosity : null;
      const portion_water_ml_other_meal_saturo = portion_g_other_meal_saturo != 0 ? (portionWaterMlVariant / 100) * portion_g_other_meal_saturo * portion_water_viscosity : null;
      const portion_water_ml_snack_saturo = portion_g_snack_saturo != 0 ? (portionWaterMlVariant / 100) * portion_g_snack_saturo * portion_water_viscosity : null;

      return {
        portion_g_breakfast_saturo,
        portion_g_lunch_saturo,
        portion_g_dinner_saturo,
        portion_g_other_main_meal_saturo,
        portion_g_snack_saturo,
        portion_g_other_meal_saturo,
        variant_id: variantId,
        nutrition_facts_100g: nutritionFacts100g,
        nutrition_facts_breakfast: nutritionFactsBreakfast,
        nutrition_facts_lunch: nutritionFactsLunch,
        nutrition_facts_dinner: nutritionFactsDinner,
        nutrition_facts_snack: nutritionFactsSnack,
        nutrition_facts_other_meal: nutritionFactsOtherMeal,
        flavor,
        best_before_date,
        ingredients,
        portion_g,
        portion_water_ml,
        portion_water_ml_breakfast_saturo: portion_water_ml_breakfast_saturo ? Number(portion_water_ml_breakfast_saturo.toFixed(0)) : portion_water_ml_breakfast_saturo,
        portion_water_ml_lunch_saturo: portion_water_ml_lunch_saturo ? Number(portion_water_ml_lunch_saturo.toFixed(0)) : portion_water_ml_lunch_saturo,
        portion_water_ml_dinner_saturo: portion_water_ml_dinner_saturo ? Number(portion_water_ml_dinner_saturo.toFixed(0)) : portion_water_ml_dinner_saturo,
        portion_water_ml_other_main_meal_saturo: portion_water_ml_other_main_meal_saturo ? Number(portion_water_ml_other_main_meal_saturo.toFixed(0)) : portion_water_ml_other_main_meal_saturo,
        portion_water_ml_other_meal_saturo: portion_water_ml_other_meal_saturo ? Number(portion_water_ml_other_meal_saturo.toFixed(0)) : portion_water_ml_other_meal_saturo,
        portion_water_ml_snack_saturo: portion_water_ml_snack_saturo ? Number(portion_water_ml_snack_saturo.toFixed(0)) : portion_water_ml_snack_saturo,
        makrosplit_fibre,
        makrosplit_protein,
        makrosplit_fat,
        makrosplit_carbohydrate,
        filling_size_kcal,
        filling_size_g,
        scoop_size_g_unit,
        scoop_size_g,
        usp_1,
        usp_2,
        usp_3,
        usp_header,
        gluten,
        sugarfree,
        peanut,
        product_charge,
        nutrition_facts_table_combined
      }
    }

    if (label_create_datetime) {
      let {
        personalized_por_breakfast_sat_max_kcal,
        personalized_por_lunch_sat_max_kcal,
        personalized_por_dinner_sat_max_kcal,
        personalized_por_other_m_meal_sat_max_kcal,
        personalized_por_snack_sat_max_kcal,
        personalized_por_other_sat_max_kcal,
        personalized_portion_max_kcal_min,
        personalized_portion_max_kcal_max,
      } = perfectProduct.ProductMetafields

      const {
        personalized_adjust_factor_breakfast_saturo,
        personalized_adjust_factor_lunch_saturo,
        personalized_adjust_factor_dinner_saturo,
        personalized_adjust_factor_other_main_meal_saturo,
        personalized_adjust_factor_snack_saturo,
        personalized_adjust_factor_other_meal_saturo,
        personalized_hydration_max_limit_kcal,
        personalized_kcal_l_kcal_reduced,
        personalized_kcal_l_softdrink_fruit,
        personalized_kcal_l_other,
      } = shopMeta

      const personalized_adjust_factor_breakfast_saturo_value =
        personalized_adjust_factor_breakfast_saturo
          ? Number(personalized_adjust_factor_breakfast_saturo)
          : 1
      const personalized_adjust_factor_lunch_saturo_value =
        personalized_adjust_factor_lunch_saturo
          ? Number(personalized_adjust_factor_lunch_saturo)
          : 1
      const personalized_adjust_factor_dinner_saturo_value =
        personalized_adjust_factor_dinner_saturo
          ? Number(personalized_adjust_factor_dinner_saturo)
          : 1
      const personalized_adjust_factor_other_main_meal_saturo_value =
        personalized_adjust_factor_other_main_meal_saturo
          ? Number(personalized_adjust_factor_other_main_meal_saturo)
          : 1
      const personalized_adjust_factor_snack_saturo_value =
        personalized_adjust_factor_snack_saturo
          ? Number(personalized_adjust_factor_snack_saturo)
          : 1
      const personalized_adjust_factor_other_meal_saturo_value =
        personalized_adjust_factor_other_meal_saturo
          ? Number(personalized_adjust_factor_other_meal_saturo)
          : 1

      // Product Metafield
      const personalized_portion_max_kcal_min_number = Number(
        personalized_portion_max_kcal_min
      )
      const personalized_portion_max_kcal_max_number = Number(
        personalized_portion_max_kcal_max
      )

      function randomNum(min, max) {
        return Number(Math.floor(Math.random() * (max - min + 1)) + min)
      }

      const portion_max_kcal_rand = randomNum(
        personalized_portion_max_kcal_min_number,
        personalized_portion_max_kcal_max_number
      )

      const por_breakfast_sat_max_kcal =
        Number(personalized_por_breakfast_sat_max_kcal) - portion_max_kcal_rand
      const por_lunch_sat_max_kcal =
        Number(personalized_por_lunch_sat_max_kcal) - portion_max_kcal_rand
      const por_dinner_sat_max_kcal =
        Number(personalized_por_dinner_sat_max_kcal) - portion_max_kcal_rand
      const por_other_m_meal_sat_max_kcal =
        Number(personalized_por_other_m_meal_sat_max_kcal) -
        portion_max_kcal_rand
      const por_snack_sat_max_kcal =
        Number(personalized_por_snack_sat_max_kcal) - portion_max_kcal_rand
      const por_other_sat_max_kcal =
        Number(personalized_por_other_sat_max_kcal) - portion_max_kcal_rand

      const firebaseData = {
        document_last_update_datetime: new Date(),
        nutrition: {
          adj_factor_breakfast_sat:
            personalized_adjust_factor_breakfast_saturo_value,
          adj_factor_lunch_sat: personalized_adjust_factor_lunch_saturo_value,
          adj_factor_dinner_sat: personalized_adjust_factor_dinner_saturo_value,
          adj_factor_other_m_meal_sat:
            personalized_adjust_factor_other_main_meal_saturo_value,
          adj_factor_snack_sat: personalized_adjust_factor_snack_saturo_value,
          adj_factor_other_sat:
            personalized_adjust_factor_other_meal_saturo_value,
          por_breakfast_sat_max_kcal: por_breakfast_sat_max_kcal,
          por_lunch_sat_max_kcal: por_lunch_sat_max_kcal,
          por_dinner_sat_max_kcal: por_dinner_sat_max_kcal,
          por_other_m_meal_sat_max_kcal: por_other_m_meal_sat_max_kcal,
          por_snack_sat_max_kcal: por_snack_sat_max_kcal,
          por_other_sat_max_kcal: por_other_sat_max_kcal,
          portion_max_kcal_min: personalized_portion_max_kcal_min_number,
          portion_max_kcal_max: personalized_portion_max_kcal_max_number,
          portion_max_kcal_rand: portion_max_kcal_rand,
          hydration_max_limit_kcal: Number(
            personalized_hydration_max_limit_kcal
          ),
          kcal_l_kcal_reduced: Number(personalized_kcal_l_kcal_reduced),
          kcal_l_kcal_softdrink_fruit: Number(
            personalized_kcal_l_softdrink_fruit
          ),
          kcal_l_kcal_other: Number(personalized_kcal_l_other)
        },
        product_details_variant: {
          1: {
            product_charge: Number(
              perfectProduct.ProductMetafields.personalized_product_charge
            ),
            ...createProductDetailsVariant(selected_variant[0]),
          },
        },
      }

      writeDataToFirebase(firebaseData, uid)
    }

    $('body').removeClass('loading');
    $('[data-personalized-quiz-loader]').remove();

    saturo.localProductDetailsVariants = {
      1: product_details_variant[1]
    }

    $("[data-quiz-variants-add-to-cart]").on("click", function () {
      let firebaseVariants = {
        ...saturo.localProductDetailsVariants
      }
      let variantsIndex = Object.keys(saturo.localProductDetailsVariants).length || 1; 

      $(".product-form [data-qty-input]").each(function (index) {
        const variantId = Number($(this).attr("data-qty-input"))

        if (
          variantId &&
          $(this).val() > 0 &&
          variantId !== selected_variant[0].variantId &&
          !Object.values(saturo.localProductDetailsVariants).filter(item => item.variant_id === variantId).length > 0
        ) {
          variantsIndex++;

          const variantArray = perfectProduct.ProductVariants.filter(
            (item) => item.variantId === variantId
          )

          if (variantArray.length > 0) {
            firebaseVariants = {
              ...firebaseVariants,
              [variantsIndex]: {
                ...createProductDetailsVariant(variantArray[0]),
              },
            }
          }
        }
      })

      saturo.toggleButtonLoader($(this))

      saturo.localProductDetailsVariants = {
        ...saturo.localProductDetailsVariants,
        ...firebaseVariants
      }

      writeDataToFirebase(
        {
          label: labelStaticTranslations,
          product_details_variant: {
            ...saturo.localProductDetailsVariants,
            ...firebaseVariants,
          },
        },
        uid
      ).then(function () {
        saturo.addQuizVariantsToCart()
      })
    })
  }
})


   

    
